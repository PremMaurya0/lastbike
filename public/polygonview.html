<!DOCTYPE html>
<html>
  <head>
    <title>Polygon Arrays</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZIIPkxUOhnlEUuegCFhDUpcAvTQIXozs&callback=initMap&libraries=drawing&v=weekly"
      defer
    ></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
#map {
  height: 80%;
}

/* Optional: Makes the sample page fill the window. */
html,
body {
  height: 100%;
  margin: 0;
  padding: 0;
}

    </style>
  </head>
  <body>


    <!-- The Modal -->
<div class="modal" id="myModal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Modal Heading</h4>
        <button type="button" class="btn close"  data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      <div class="modal-body">
        Wrong Value?
      </div>

      <!-- Modal footer -->
      <div class="modal-footer">
        <button type="button"  class="btn btn-primary">Save</button>
      </div>

    </div>
  </div>
</div>
  
    <div id="map"></div>
    <script src="/socket.io/socket.io.js"></script>
  <script>
  var Coords=[],bikeListData=[],shapename;
  const socket = io('http://localhost:3001/',{'forceNew':true, query: "foo="+getParameterByName("area") });
        socket.on('connect',function(data) {    
            console.log("Server is connected");
        });
  
function areaSingle(areaname){
  return new Promise((resolve, reject) => {
            $.ajax({
                  type: "Post",
                  url: "http://localhost:3001/api/v1/areaSingle",
                  data:{"areanumber":areaname},
                  success: function (response) {
                   
                    Coords=[];
                    shapename=response.shapetype;
                    for(var x=0;x<response.List.length;x++){
                      Coords.push({lat:parseFloat(response.List[x].lat),lng:parseFloat(response.List[x].lng)})
                    }
                     $.ajax({
                  type: "Post",
                  url: "http://localhost:3001/api/v1/vechileareaList",
                  data:{"area":areaname},
                  success: function (response) {
                   //console.log(response);
                   
                    bikeListData=[];
                    //shapename=response.shapetype;
                    for(var x=0;x<response.length;x++){
                      bikeListData.push({lat:parseFloat(response[x].lat),lng:parseFloat(response[x].lng)})
                    }
                    resolve(response);
                  
                  },
                  failure: function (msg) {
                    console.log(msg);
                   // reject(msg);
                  }
              });
            
                    
                    //resolve(response.shapetype);
                   
                  },
                  failure: function (msg) {
                    console.log(msg);
                    reject(msg);
                  }
              });
            });
        }

     

// This example creates a simple polygon representing the Bermuda Triangle.
// When the user clicks on the polygon an info window opens, showing
// information about the polygon's coordinates.

let map;
var modal = document.getElementById("myModal");
function initMap() {
  
if(Coords.length<=0){
modal.style.display = "block";
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 8,
    center: { lat: 28.6139, lng:77.2090 },
    mapTypeId: "terrain",
  });
}
 

}
var newBikelist=[];

// function setMarkers() {
//  // console.log("==> ",bikeListData);
//       for (var i = 0; i < bikeListData.length; i++) {
//          var  marker = new google.maps.Marker({
//              map: map,
//              draggable:false,
//              position: new google.maps.LatLng(bikeListData[x].lat,bikeListData[x].lng),
//          });
//       }
//     }
//     setInterval(function() { setMarkers(); }, 5000);
var markers=[];
function initMap2(){
   
 // if(Coords.length>0){
  modal.style.display = "none";
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 7,
    center: { lat: Coords[0].lat, lng:Coords[0].lng },
    mapTypeId: "terrain",
  });

  if(shapename=="polygon"){

const region = new google.maps.Polygon({
map: map,
clickable: false,
paths: Coords,
});


var bounds = new google.maps.LatLngBounds();
for (var i = 0; i < region.getPath().getLength(); i++) {
bounds.extend(region.getPath().getAt(i));
}
map.fitBounds(bounds);

}
else{
    
    var latlng=new google.maps.LatLng(Coords[0].lat, Coords[0].lng);
    const cityCircle = new google.maps.Circle({
      strokeColor: "#FF0000",
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: "#FF0000",
      radius: 100000,
      fillOpacity: 0.35,
      map,
      center: Coords[0],
      //radius: Math.sqrt(citymap[city].population) * 1000,
    });
   
    var bounds = cityCircle.getBounds();

  }

  socket.on('bikeList',response=>{
          newBikelist=[]; 
          //removeMarkers(); 
          DeleteMarkers(); 
         for(var x=0;x<response.length;x++){

              newBikelist.push({lat:parseFloat(response[x].lat),lng:parseFloat(response[x].lng)});

          }

      for(var x=0;x<newBikelist.length;x++){ 
    
       var marker = new google.maps.Marker({
          map: map,
          draggable:false,
          position: new google.maps.LatLng(newBikelist[x].lat,newBikelist[x].lng),
        });
        markers.push(marker);
       }
  
   });
  
}

function DeleteMarkers() {
        //Loop through all the markers and remove
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    };

$(".btn").on("click",function(){
  modal.style.display = "none";
  window.location.href="arealist.html";
})

function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

areaSingle(getParameterByName("area")).then(initMap2);
  </script>
    </body>
</html>